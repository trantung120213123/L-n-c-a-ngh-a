<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Xá»‹n - Tung vs Gau</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --bg-primary: #f8fafc; --bg-secondary: #ffffff; --text-primary: #0f172a; --accent: #4f46e5; }
    [data-theme="dark"] { --bg-primary: #0f172a; --bg-secondary: #1e293b; --text-primary: #f1f5f9; --accent: #7c3aed; }
    body { background: linear-gradient(to-br, var(--accent), #ec4899); transition: all 0.3s; }
    .bg-primary { background: var(--bg-primary); }
    .bg-secondary { background: var(--bg-secondary); }
    .text-primary { color: var(--text-primary); }
    .message { margin-bottom: 1rem; animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .message.sent { text-align: right; }
    .message.received { text-align: left; }
    .message-content { display: inline-block; max-width: 70%; padding: 0.75rem 1rem; border-radius: 1.5rem; word-wrap: break-word; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .sent .message-content { background: linear-gradient(to right, var(--accent), #7c3aed); color: white; }
    .received .message-content { background: #e2e8f0; color: #334155; }
    [data-theme="dark"] .received .message-content { background: #334155; color: #f1f5f9; }
    img, video { max-width: 100%; border-radius: 0.75rem; max-height: 300px; object-fit: cover; }
    #messages { scrollbar-width: thin; scrollbar-color: var(--accent) transparent; }
    #messages::-webkit-scrollbar { width: 6px; }
    #messages::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 3px; }
    .toast { position: fixed; top: 20px; right: 20px; padding: 1rem; border-radius: 0.5rem; color: white; z-index: 1000; transform: translateX(100%); transition: transform 0.3s; }
    .toast.show { transform: translateX(0); }
    .toast.error { background: #ef4444; }
    .toast.success { background: #10b981; }
    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #dropZone { border: 2px dashed #cbd5e1; border-radius: 0.5rem; padding: 2rem; text-align: center; transition: all 0.3s; }
    #dropZone.dragover { border-color: var(--accent); background: #eff6ff; }
    .typing-indicator { font-style: italic; color: #64748b; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .emoji-picker { position: absolute; bottom: 100px; left: 0; background: var(--bg-secondary); border-radius: 0.5rem; padding: 0.5rem; box-shadow: 0 10px 15px rgba(0,0,0,0.1); display: none; z-index: 10; }
    .emoji { font-size: 1.5rem; cursor: pointer; margin: 0.2rem; }
    .online-status { position: absolute; top: -5px; right: -5px; width: 12px; height: 12px; background: #10b981; border-radius: 50%; border: 2px solid white; }
    [data-theme="dark"] .online-status { border-color: #1e293b; }
  </style>
</head>
<body class="bg-primary text-primary transition-all h-screen flex items-center justify-center overflow-hidden">
  <!-- Dark Mode Toggle -->
  <button id="themeToggle" class="fixed top-4 right-4 p-2 rounded-full bg-secondary shadow-lg z-40">ğŸŒ™</button>

  <!-- Loading -->
  <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-secondary p-8 rounded-lg shadow-xl text-center">
      <div class="loading mx-auto mb-4"></div>
      <p class="text-primary">Äang káº¿t ná»‘i...</p>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-secondary p-8 rounded-xl shadow-2xl w-96 animate-bounce">
      <h2 class="text-3xl font-bold mb-6 text-center text-primary">ğŸš€ Chat Xá»‹n</h2>
      <form id="loginForm">
        <input type="text" id="username" placeholder="TÃ i khoáº£n (tung/gau)" class="w-full p-4 mb-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-accent transition bg-primary">
        <input type="password" id="password" placeholder="Máº­t kháº©u" class="w-full p-4 mb-6 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-accent transition bg-primary">
        <button type="submit" class="w-full bg-gradient-to-r from-accent to-purple-600 text-white py-4 rounded-xl hover:from-blue-600 hover:to-purple-700 transition-all font-semibold">ÄÄƒng Nháº­p</button>
        <button type="button" id="testConnect" class="w-full mt-2 text-sm text-accent underline hover:text-purple-700">Test Káº¿t Ná»‘i</button>
      </form>
      <p id="loginError" class="text-red-500 mt-4 hidden text-center font-medium">Sai thÃ´ng tin!</p>
    </div>
  </div>

  <!-- Chat -->
  <div id="chatContainer" class="hidden w-full max-w-4xl h-[90vh] bg-secondary rounded-2xl shadow-2xl flex flex-col mx-auto animate-slide-up relative">
    <div class="bg-gradient-to-r from-emerald-500 to-blue-600 p-6 text-white rounded-t-2xl flex justify-between items-center">
      <div class="flex items-center">
        <h1 class="text-2xl font-bold">ğŸ’¬ Chat Room</h1>
        <div id="onlineStatus" class="ml-2 flex items-center">
          <span class="text-sm opacity-90">Online: <span id="onlineCount">0</span></span>
          <div class="online-status ml-1"></div>
        </div>
      </div>
      <button id="logout" class="px-4 py-2 bg-white bg-opacity-20 rounded-xl hover:bg-opacity-30 transition">Logout</button>
    </div>
    <div id="messages" class="flex-1 p-6 overflow-y-auto bg-primary"></div>
    <div class="p-6 border-t bg-secondary rounded-b-2xl relative">
      <div id="typingIndicator" class="mb-2 hidden typing-indicator">Äang gÃµ...</div>
      <form id="messageForm" class="flex gap-3 items-end">
        <div id="dropZone" class="flex-1 p-4 border-2 border-dashed border-gray-300 rounded-xl hidden group cursor-pointer bg-primary">
          <p class="text-gray-500">KÃ©o tháº£ áº£nh/video hoáº·c click ğŸ“</p>
        </div>
        <div class="flex-1 relative">
          <input type="text" id="messageInput" placeholder="Nháº­p tin nháº¯n..." class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-accent resize-none bg-primary" rows="1">
          <div class="emoji-picker">
            <span class="emoji" onclick="addEmoji('ğŸ˜€')">ğŸ˜€</span>
            <span class="emoji" onclick="addEmoji('ğŸ˜‚')">ğŸ˜‚</span>
            <span class="emoji" onclick="addEmoji('â¤ï¸')">â¤ï¸</span>
            <span class="emoji" onclick="addEmoji('ğŸ‘')">ğŸ‘</span>
            <span class="emoji" onclick="addEmoji('ğŸ”¥')">ğŸ”¥</span>
          </div>
          <button type="button" id="emojiBtn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-2xl">ğŸ˜Š</button>
        </div>
        <input type="file" id="fileInput" accept="image/*,video/*" class="hidden">
        <button type="button" id="attachBtn" class="p-4 bg-gray-100 rounded-xl hover:bg-gray-200 transition">ğŸ“</button>
        <button type="submit" class="p-4 bg-gradient-to-r from-accent to-purple-600 text-white rounded-xl hover:from-blue-600 hover:to-purple-700 transition px-6">Gá»­i</button>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast hidden"></div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const BACKEND_URL = 'https://chat-mx5q.onrender.com'; // Thay URL Render!
    const socket = io(BACKEND_URL, { reconnection: true, reconnectionAttempts: 5, timeout: 20000 });
    let currentUser = '', currentReceiver = '', isConnected = false, typingTimer;

    // Utils
    function showToast(message, type = 'success') { /* Giá»‘ng cÅ© */ }
    function showLoading(show = true) { /* Giá»‘ng cÅ© */ }
    function escapeHtml(text) { /* Giá»‘ng cÅ© */ }
    function displayMessages(messages) { /* Giá»‘ng cÅ©, thÃªm smooth scroll */ container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' }); }

    // Theme toggle
    document.getElementById('themeToggle').addEventListener('click', () => {
      document.body.dataset.theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
      document.getElementById('themeToggle').textContent = document.body.dataset.theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    });

    // Socket events (thÃªm typing, online)
    socket.on('connect', () => { isConnected = true; showLoading(false); });
    socket.on('disconnect', () => { isConnected = false; if (currentUser) showLoading(true); });
    socket.on('connect_error', (error) => showToast('Lá»—i káº¿t ná»‘i: ' + error.message, 'error'));
    socket.on('user_online', (users) => { document.getElementById('onlineCount').textContent = users.length; });
    socket.on('user_typing', (data) => {
      const indicator = document.getElementById('typingIndicator');
      if (data.typing && data.sender !== currentUser) {
        indicator.classList.remove('hidden');
      } else {
        indicator.classList.add('hidden');
      }
    });

    // Login & events (giá»‘ng cÅ©, thÃªm emit typing)
    document.getElementById('messageInput').addEventListener('input', (e) => {
      socket.emit('typing', { receiver: currentReceiver, typing: e.target.value.length > 0 });
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => socket.emit('typing', { receiver: currentReceiver, typing: false }), 1000);
    });

    // Emoji
    function addEmoji(emoji) {
      document.getElementById('messageInput').value += emoji;
      document.querySelector('.emoji-picker').style.display = 'none';
    }
    document.getElementById('emojiBtn').addEventListener('click', () => {
      const picker = document.querySelector('.emoji-picker');
      picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
    });

    // CÃ¡c event khÃ¡c giá»‘ng cÅ© (login, send, upload, testConnect, drag-drop)
    // ... (copy tá»« code trÆ°á»›c, thÃªm check isConnected cho send/upload)

    // Init
    if (socket.connected) isConnected = true;
  </script>
</body>
</html>
