<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Xá»‹n - Tung vs Gau</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .message { margin-bottom: 1rem; animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .message.sent { text-align: right; }
    .message.received { text-align: left; }
    .message-content { display: inline-block; max-width: 70%; padding: 0.75rem 1rem; border-radius: 1.5rem; word-wrap: break-word; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .sent .message-content { background: linear-gradient(to right, #4f46e5, #7c3aed); color: white; }
    .received .message-content { background: #f1f5f9; color: #334155; }
    img, video { max-width: 100%; border-radius: 0.75rem; max-height: 300px; object-fit: cover; }
    #messages { scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent; }
    #messages::-webkit-scrollbar { width: 6px; }
    #messages::-webkit-scrollbar-track { background: transparent; }
    #messages::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .toast { position: fixed; top: 20px; right: 20px; padding: 1rem; border-radius: 0.5rem; color: white; z-index: 1000; transform: translateX(100%); transition: transform 0.3s; }
    .toast.show { transform: translateX(0); }
    .toast.error { background: #ef4444; }
    .toast.success { background: #10b981; }
    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    /* Drag-drop */
    #dropZone { border: 2px dashed #cbd5e1; border-radius: 0.5rem; padding: 2rem; text-align: center; transition: all 0.3s; }
    #dropZone.dragover { border-color: #4f46e5; background: #eff6ff; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-500 via-purple-600 to-pink-500 h-screen flex items-center justify-center overflow-hidden">
  <!-- Loading Spinner -->
  <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-8 rounded-lg shadow-xl text-center">
      <div class="loading mx-auto mb-4"></div>
      <p class="text-gray-700">Äang káº¿t ná»‘i...</p>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-96 animate-bounce">
      <h2 class="text-3xl font-bold mb-6 text-center text-gray-800">ğŸš€ Chat Xá»‹n</h2>
      <form id="loginForm">
        <input type="text" id="username" placeholder="TÃ i khoáº£n (tung/gau)" class="w-full p-4 mb-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
        <input type="password" id="password" placeholder="Máº­t kháº©u" class="w-full p-4 mb-6 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
        <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-4 rounded-xl hover:from-blue-600 hover:to-purple-700 transition-all font-semibold">ÄÄƒng Nháº­p</button>
      </form>
      <p id="loginError" class="text-red-500 mt-4 hidden text-center font-medium">Sai thÃ´ng tin!</p>
    </div>
  </div>

  <!-- Chat -->
  <div id="chatContainer" class="hidden w-full max-w-4xl h-[90vh] bg-white rounded-2xl shadow-2xl flex flex-col mx-auto animate-slide-up">
    <div class="bg-gradient-to-r from-emerald-500 to-blue-600 p-6 text-white rounded-t-2xl flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-bold">ğŸ’¬ Chat Room</h1>
        <p class="text-sm opacity-90">Online vá»›i báº¡n</p>
      </div>
      <button id="logout" class="px-4 py-2 bg-white bg-opacity-20 rounded-xl hover:bg-opacity-30 transition">Logout</button>
    </div>
    <div id="messages" class="flex-1 p-6 overflow-y-auto bg-gradient-to-b from-gray-50 to-white"></div>
    <div class="p-6 border-t bg-white rounded-b-2xl">
      <form id="messageForm" class="flex gap-3 items-end">
        <div id="dropZone" class="flex-1 p-4 border-2 border-dashed border-gray-300 rounded-xl hidden group">
          <p class="text-gray-500">KÃ©o tháº£ áº£nh/video hoáº·c click ğŸ“</p>
        </div>
        <input type="text" id="messageInput" placeholder="Nháº­p tin nháº¯n..." class="flex-1 p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" rows="1">
        <input type="file" id="fileInput" accept="image/*,video/*" class="hidden">
        <button type="button" id="attachBtn" class="p-4 bg-gray-100 rounded-xl hover:bg-gray-200 transition">ğŸ“</button>
        <button type="submit" class="p-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl hover:from-blue-600 hover:to-purple-700 transition px-6">Gá»­i</button>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast hidden"></div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    // Config backend URL (thay báº±ng Render URL cá»§a mÃ y)
    const BACKEND_URL = 'https://chat-mx5q.onrender.com'; // Thay Ä‘Ã¢y!
    const socket = io(BACKEND_URL);

    let currentUser = '';
    let currentReceiver = '';

    // Utils
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.classList.remove('hidden', 'show');
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.classList.add('hidden'), 300);
      }, 3000);
    }

    function showLoading(show = true) {
      document.getElementById('loading').classList.toggle('hidden', !show);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function displayMessages(messages) {
      const container = document.getElementById('messages');
      messages.forEach(msg => {
        const div = document.createElement('div');
        div.className = `message ${msg.sender === currentUser ? 'sent' : 'received'}`;
        let content = '';
        if (msg.message_type === 'text') {
          content = `<div class="message-content">${escapeHtml(msg.message_text)}</div>`;
        } else if (msg.message_type === 'image') {
          content = `<div class="message-content"><img src="${msg.file_url}" alt="áº¢nh" loading="lazy" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIGVycm9yPC90ZXh0Pjwvc3ZnPg=='"></div>`;
        } else if (msg.message_type === 'video') {
          content = `<div class="message-content"><video src="${msg.file_url}" controls preload="metadata" onerror="this.src=''; this.outerHTML='<p>Lá»—i video</p>'"></video></div>`;
        }
        div.innerHTML = `<small class="block text-gray-500 text-xs mb-2">${new Date(msg.created_at).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}</small>${content}`;
        container.appendChild(div);
      });
      container.scrollTop = container.scrollHeight;
    }

    // Events
    document.getElementById('loginForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      if (!username || !password) return showToast('Nháº­p Ä‘áº§y Ä‘á»§!', 'error');
      showLoading(true);
      socket.emit('login', { username, password });
    });

    socket.on('connect', () => showLoading(false));
    socket.on('disconnect', () => showLoading(true)); // Reconnect náº¿u cáº§n

    socket.on('login_success', (data) => {
      currentUser = document.getElementById('username').value;
      currentReceiver = currentUser === 'tung' ? 'gau' : 'tung';
      document.getElementById('loginModal').classList.add('hidden');
      document.getElementById('chatContainer').classList.remove('hidden');
      showToast('ChÃ o má»«ng! ÄÃ£ load tin nháº¯n cÅ©.');
    });

    socket.on('login_error', (data) => {
      showLoading(false);
      showToast(data.message, 'error');
    });

    socket.on('load_messages', displayMessages);
    socket.on('new_message', (msg) => displayMessages([msg]));
    socket.on('send_error', (data) => showToast(data.message, 'error'));

    document.getElementById('logout').addEventListener('click', () => location.reload());

    // Send text
    document.getElementById('messageForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const text = document.getElementById('messageInput').value.trim();
      if (text && currentUser) {
        socket.emit('send_message', { receiver: currentReceiver, message_text: text, message_type: 'text' });
        document.getElementById('messageInput').value = '';
      }
    });

    // File upload + drag-drop
    const fileInput = document.getElementById('fileInput');
    const attachBtn = document.getElementById('attachBtn');
    const dropZone = document.getElementById('dropZone');
    const messageInput = document.getElementById('messageInput');

    attachBtn.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('click', () => fileInput.click());

    [attachBtn, dropZone].forEach(el => {
      el.addEventListener('dragover', (e) => {
        e.preventDefault();
        el.classList.add('dragover');
        dropZone.classList.remove('hidden');
      });
      el.addEventListener('dragleave', () => {
        el.classList.remove('dragover');
        if (!dropZone.matches(':hover')) dropZone.classList.add('hidden');
      });
    });

    ['drop', 'change'].forEach(event => {
      fileInput.addEventListener(event, async (e) => {
        const file = e.target.files?.[0] || e.dataTransfer?.files?.[0];
        if (!file) return;
        dropZone.classList.add('hidden');
        if (file.size > 50 * 1024 * 1024) return showToast('File quÃ¡ lá»›n (>50MB)!', 'error');

        const formData = new FormData();
        formData.append('file', file);
        showLoading(true);
        try {
          const res = await fetch(`${BACKEND_URL}/upload`, { method: 'POST', body: formData });
          if (!res.ok) throw new Error(await res.text());
          const { url } = await res.json();
          const type = file.type.startsWith('image/') ? 'image' : 'video';
          if (currentUser) socket.emit('send_message', { receiver: currentReceiver, message_type: type, file_url: url });
          showToast('Gá»­i file OK!');
        } catch (err) {
          console.error(err);
          showToast('Lá»—i upload: ' + err.message, 'error');
        }
        showLoading(false);
        if (event === 'change') fileInput.value = '';
      });
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover', 'hidden');
    });

    // Auto-resize input
    messageInput.addEventListener('input', () => {
      messageInput.style.height = 'auto';
      messageInput.style.height = messageInput.scrollHeight + 'px';
    });
  </script>
</body>
</html>
