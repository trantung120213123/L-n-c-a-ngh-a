<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat X·ªãn - Tung vs Gau</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .message { margin-bottom: 1rem; }
    .message.sent { text-align: right; }
    .message.received { text-align: left; }
    .message-content { display: inline-block; max-width: 70%; padding: 0.5rem 1rem; border-radius: 1rem; word-wrap: break-word; }
    .sent .message-content { background: linear-gradient(to right, #4f46e5, #7c3aed); color: white; }
    .received .message-content { background: #e5e7eb; color: black; }
    img, video { max-width: 100%; border-radius: 0.5rem; max-height: 300px; cursor: pointer; }
    img:hover { opacity: 0.8; transition: opacity 0.2s; }
    #messages { overflow-y: auto; max-height: 400px; padding: 10px; background: #f9fafb; }
    .toast { position: fixed; top: 20px; right: 20px; padding: 1rem; border-radius: 0.5rem; color: white; z-index: 1000; transform: translateX(100%); transition: transform 0.3s; }
    .toast.show { transform: translateX(0); }
    .toast.error { background: #ef4444; }
    .toast.success { background: #10b981; }
    .loading { width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .optimistic { opacity: 0.7; transition: opacity 0.3s; }
    /* Image Modal */
    #imageModal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); }
    #imageModal img { margin: auto; display: block; max-width: 90%; max-height: 90%; }
    #closeModal { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; z-index: 1002; }
    #closeModal:hover { color: #ccc; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-500 to-purple-600 h-screen flex items-center justify-center p-4">
  <!-- Loading Spinner -->
  <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-8 rounded-lg shadow-xl text-center">
      <div class="loading mx-auto mb-4"></div>
      <p class="text-gray-700">ƒêang k·∫øt n·ªëi...</p>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
    <h2 class="text-2xl font-bold mb-4 text-center text-gray-800">ƒêƒÉng Nh·∫≠p Chat</h2>
    <form id="loginForm">
      <input type="text" id="username" placeholder="T√†i kho·∫£n (tung/gau)" class="w-full p-3 mb-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
      <input type="password" id="password" placeholder="M·∫≠t kh·∫©u" class="w-full p-3 mb-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
      <button type="submit" id="loginBtn" class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition disabled:bg-gray-400">ƒêƒÉng Nh·∫≠p</button>
      <button type="button" id="testConnect" class="w-full mt-2 text-blue-500 underline hover:text-blue-700 text-sm">Test K·∫øt N·ªëi</button>
    </form>
    <p id="loginError" class="text-red-500 mt-2 hidden text-center">Sai th√¥ng tin!</p>
  </div>

  <!-- Chat Container -->
  <div id="chatContainer" class="hidden w-full max-w-2xl h-4/5 bg-white rounded-lg shadow-2xl flex flex-col">
    <div class="bg-gradient-to-r from-green-400 to-blue-500 p-4 text-white rounded-t-lg flex justify-between">
      <h1 class="text-xl font-bold">Ph√≤ng Chat</h1>
      <button id="logout" class="hover:underline">ƒêƒÉng Xu·∫•t</button>
    </div>
    <div id="messages" class="flex-1 overflow-y-auto p-4 bg-gray-50"></div>
    <div class="p-4 border-t">
      <form id="messageForm" class="flex gap-2">
        <input type="text" id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn (h·ªó tr·ª£ ti·∫øng Vi·ªát)..." class="flex-1 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        <input type="file" id="fileInput" accept="image/*,video/*" class="hidden">
        <button type="button" id="attachBtn" class="p-3 bg-gray-200 rounded-lg hover:bg-gray-300">üìé</button>
        <button type="submit" class="p-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600">G·ª≠i</button>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast hidden"></div>

  <!-- Image Zoom Modal -->
  <div id="imageModal">
    <span id="closeModal">&times;</span>
    <img id="modalImage" src="" alt="Zoom Image">
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    // Backend URL
    const BACKEND_URL = 'https://chat-mx5q.onrender.com';
    const socket = io(BACKEND_URL, { reconnection: true, reconnectionAttempts: 5, timeout: 20000 });
    let currentUser = '';
    let currentReceiver = '';
    let isConnected = false;
    let pendingMessages = []; // Track optimistic messages

    // Utils
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.classList.add('hidden'), 300);
      }, 3000);
    }

    function showLoading(show = true) {
      const loadingEl = document.getElementById('loading');
      if (show) {
        loadingEl.classList.remove('hidden');
        setTimeout(() => loadingEl.classList.add('hidden'), 2000);
      } else {
        loadingEl.classList.add('hidden');
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function addMessageLocally(msg, isOptimistic = false) {
      const container = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = `message ${msg.sender === currentUser ? 'sent' : 'received'}${isOptimistic ? ' optimistic' : ''}`;
      let content = '';
      if (msg.message_type === 'text') {
        content = `<div class="message-content">${escapeHtml(msg.message_text)}</div>`;
      } else if (msg.message_type === 'image') {
        content = `<div class="message-content"><img src="${msg.file_url}" alt="·∫¢nh" loading="lazy" onerror="this.style.display='none'; console.error('L·ªói load ·∫£nh:', this.src)"></div>`;
      } else if (msg.message_type === 'video') {
        content = `<div class="message-content"><video src="${msg.file_url}" controls preload="metadata" onerror="this.outerHTML='<p>L·ªói video</p>'; console.error('L·ªói load video:', this.src)"></video></div>`;
      }
      div.innerHTML = `<small class="block text-gray-500 text-xs mb-1">${new Date(msg.created_at || new Date()).toLocaleTimeString('vi-VN')}</small>${content}`;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
      if (isOptimistic) pendingMessages.push(msg.localId || Date.now()); // Track ID
    }

    function displayMessages(messages) {
      messages.forEach(msg => {
        // Skip if self-sent (echo from server) - already added optimistic
        if (msg.sender === currentUser && pendingMessages.includes(msg.localId || msg.id)) {
          // Just confirm optimistic (remove opacity)
          const optimisticDivs = document.querySelectorAll('.optimistic');
          optimisticDivs.forEach(div => div.classList.remove('optimistic'));
          pendingMessages = pendingMessages.filter(id => id !== (msg.localId || msg.id));
          return;
        }
        // Add received or non-pending
        const pendingId = msg.localId || msg.id;
        if (pendingMessages.includes(pendingId)) {
          // Remove old optimistic if any
          const optimisticDivs = document.querySelectorAll('.optimistic');
          optimisticDivs.forEach(div => div.remove());
          pendingMessages = pendingMessages.filter(id => id !== pendingId);
        }
        addMessageLocally(msg, false);
      });
    }

    // Socket events
    socket.on('connect', () => {
      isConnected = true;
      console.log('Socket connected!');
      showLoading(false);
      const loginBtn = document.getElementById('loginBtn');
      loginBtn.disabled = false;
      if (currentUser) showToast('K·∫øt n·ªëi ·ªïn ƒë·ªãnh!');
      else showToast('K·∫øt n·ªëi OK, s·∫µn s√†ng ƒëƒÉng nh·∫≠p!');
    });

    socket.on('disconnect', (reason) => {
      isConnected = false;
      console.log('Socket disconnected:', reason);
      const loginBtn = document.getElementById('loginBtn');
      loginBtn.disabled = true;
      if (currentUser) showToast('M·∫•t k·∫øt n·ªëi, th·ª≠ l·∫°i...', 'error');
    });

    socket.on('connect_error', (error) => {
      console.error('Connect error:', error);
      showToast('L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
      document.getElementById('loginBtn').disabled = true;
    });

    socket.on('login_success', (data) => {
      console.log('Login success:', data);
      currentUser = document.getElementById('username').value;
      currentReceiver = currentUser === 'tung' ? 'gau' : 'tung';
      document.getElementById('loginModal').style.display = 'none';
      document.getElementById('chatContainer').style.display = 'flex'; // Force show chat
      document.getElementById('messageInput').focus();
      showLoading(false);
      showToast('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!');
    });

    socket.on('login_error', (data) => {
      console.log('Login error:', data);
      showLoading(false);
      document.getElementById('loginError').classList.remove('hidden');
      document.getElementById('loginError').textContent = data.message;
      setTimeout(() => document.getElementById('loginError').classList.add('hidden'), 3000);
      const loginBtn = document.getElementById('loginBtn');
      loginBtn.disabled = false;
      loginBtn.textContent = 'ƒêƒÉng Nh·∫≠p';
    });

    socket.on('load_messages', (messages) => {
      console.log('Loaded messages:', messages);
      displayMessages(messages);
    });

    socket.on('new_message', (msg) => {
      console.log('New message from server:', msg);
      displayMessages([msg]);
    });

    socket.on('send_error', (data) => {
      showToast(data.message, 'error');
      // Remove optimistic if error
      const optimisticDivs = document.querySelectorAll('.optimistic');
      optimisticDivs.forEach(div => div.remove());
    });

    // Image Modal Logic
    function openImageModal(src) {
      const modal = document.getElementById('imageModal');
      const modalImg = document.getElementById('modalImage');
      modal.style.display = 'block';
      modalImg.src = src;
    }

    function closeImageModal() {
      document.getElementById('imageModal').style.display = 'none';
    }

    // DOM ready
    document.addEventListener('DOMContentLoaded', () => {
      // Initial state: Hide chat, show login
      document.getElementById('chatContainer').classList.add('hidden');
      document.getElementById('loginBtn').disabled = true; // Disable until connected

      // Image Modal Events
      document.getElementById('closeModal').addEventListener('click', closeImageModal);
      document.getElementById('imageModal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('imageModal')) closeImageModal();
      });

      // Event delegation for image clicks in messages
      document.getElementById('messages').addEventListener('click', (e) => {
        if (e.target.tagName === 'IMG') {
          openImageModal(e.target.src);
        }
      });

      // Login form
      const loginForm = document.getElementById('loginForm');
      const loginBtn = document.getElementById('loginBtn');
      loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        if (!username || !password) {
          showToast('Nh·∫≠p ƒë·∫ßy ƒë·ªß!', 'error');
          return;
        }
        if (!isConnected) {
          showToast('Ch·ªù k·∫øt n·ªëi ·ªïn ƒë·ªãnh!', 'error');
          return;
        }
        console.log('Attempting login:', { username, password });
        loginBtn.disabled = true;
        loginBtn.textContent = 'ƒêang ƒëƒÉng nh·∫≠p...';
        showLoading(true);
        socket.emit('login', { username, password });
      });

      // Test connect
      document.getElementById('testConnect').addEventListener('click', () => {
        if (isConnected || socket.connected) {
          showToast('K·∫øt n·ªëi OK!', 'success');
        } else {
          showToast('Ch∆∞a k·∫øt n·ªëi, th·ª≠ l·∫°i...', 'error');
          socket.connect();
        }
      });

      // Logout
      document.getElementById('logout').addEventListener('click', () => location.reload());

      // Send message - OPTIMISTIC FIX
      document.getElementById('messageForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const text = document.getElementById('messageInput').value.trim();
        if (text && currentUser) {
          if (!isConnected) {
            socket.connect();
            showToast('ƒêang k·∫øt n·ªëi l·∫°i...', 'error');
            return;
          }
          const localId = Date.now();
          const localMsg = {
            id: localId, // For sync
            localId: localId,
            sender: currentUser,
            receiver: currentReceiver,
            message_text: text,
            message_type: 'text',
            created_at: new Date().toISOString()
          };
          addMessageLocally(localMsg, true); // Add optimistic
          console.log('Emit message (optimistic):', localMsg);
          socket.emit('send_message', localMsg);
          document.getElementById('messageInput').value = '';
        }
      });

      // File upload - OPTIMISTIC FIX
      document.getElementById('attachBtn').addEventListener('click', () => document.getElementById('fileInput').click());
      document.getElementById('fileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file || !currentUser) return;
        if (!isConnected) {
          socket.connect();
          showToast('ƒêang k·∫øt n·ªëi l·∫°i...', 'error');
          return;
        }
        if (file.size > 50 * 1024 * 1024) return showToast('File qu√° l·ªõn!', 'error');

        const formData = new FormData();
        formData.append('file', file);
        showLoading(true);
        try {
          const res = await fetch(`${BACKEND_URL}/upload`, { method: 'POST', body: formData });
          if (!res.ok) throw new Error(await res.text());
          const { url } = await res.json();
          console.log('Upload URL:', url);
          const type = file.type.startsWith('image/') ? 'image' : 'video';
          const localId = Date.now();
          const localMsg = {
            id: localId,
            localId: localId,
            sender: currentUser,
            receiver: currentReceiver,
            message_type: type,
            file_url: url,
            created_at: new Date().toISOString()
          };
          addMessageLocally(localMsg, true); // Add optimistic
          socket.emit('send_message', localMsg);
          showToast('G·ª≠i file OK!');
        } catch (err) {
          console.error('Upload error:', err);
          showToast('L·ªói upload: ' + err.message, 'error');
        }
        showLoading(false);
        e.target.value = '';
      });

      // Init connect check
      if (socket.connected) {
        isConnected = true;
        document.getElementById('loginBtn').disabled = false;
        showToast('K·∫øt n·ªëi s·∫µn s√†ng!', 'success');
      }
    });
  </script>
</body>
</html>
